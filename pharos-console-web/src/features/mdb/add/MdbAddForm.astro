---
/* ========================================================================
 * Project: pharos
 * Component: Web Console
 * File: src/features/mdb/add/MdbAddForm.astro
 * Author: Richard D. (https://github.com/iamrichardd)
 * License: AGPL-3.0 (See LICENSE file for details)
 * * Purpose (The "Why"):
 * UI component for adding machine records. Implements the HitL
 * (Human-in-the-Loop) pattern for staging and confirmation.
 * * Traceability:
 * Related to Task 16.6 (Issue #69).
 * ======================================================================== */
import { actions } from 'astro:actions';

interface Props {
    result: any; // Astro.getActionResult type
}

const { result } = Astro.props;
---

{result && result.error && (
    <div class="rounded-xl bg-red-50 p-4 border border-red-200">
        <p class="text-sm font-medium text-red-800">Error: {result.error.message}</p>
    </div>
)}

{result && !result.error && result.data.success && (
    <div class="rounded-xl bg-green-50 p-4 border border-green-200">
        <p class="text-sm font-medium text-green-800">{result.data.message}</p>
        <a href="/mdb" class="mt-3 inline-block text-sm text-green-700 underline font-medium">Return to Search</a>
    </div>
)}

{(!result || result.error || (result.data && result.data.staged)) && (
    <form method="POST" action={actions.addMachine} class="bg-white shadow-sm rounded-xl border border-slate-200 p-6 space-y-6">
        
        {result && !result.error && result.data.staged && (
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="text-blue-800 font-semibold mb-2">Review & Confirm (HitL)</h3>
                <p class="text-sm text-blue-700 mb-4">Please verify the record details below before committing to the Pharos server.</p>
                <dl class="grid grid-cols-1 gap-x-4 gap-y-3 sm:grid-cols-2 text-sm">
                    <div class="sm:col-span-1">
                        <dt class="font-medium text-blue-600 uppercase tracking-wider text-xs">Hostname</dt>
                        <dd class="mt-1 text-slate-900">{result.data.data.hostname}</dd>
                    </div>
                    <div class="sm:col-span-1">
                        <dt class="font-medium text-blue-600 uppercase tracking-wider text-xs">IP Address</dt>
                        <dd class="mt-1 text-slate-900">{result.data.data.ip}</dd>
                    </div>
                    <div class="sm:col-span-1">
                        <dt class="font-medium text-blue-600 uppercase tracking-wider text-xs">MAC Address</dt>
                        <dd class="mt-1 text-slate-900">{result.data.data.mac || 'N/A'}</dd>
                    </div>
                    <div class="sm:col-span-1">
                        <dt class="font-medium text-blue-600 uppercase tracking-wider text-xs">Operating System</dt>
                        <dd class="mt-1 text-slate-900">{result.data.data.os || 'N/A'}</dd>
                    </div>
                </dl>
                
                <!-- Hidden inputs to persist staged data -->
                <input type="hidden" name="hostname" value={result.data.data.hostname} />
                <input type="hidden" name="ip" value={result.data.data.ip} />
                {result.data.data.mac && <input type="hidden" name="mac" value={result.data.data.mac} />}
                {result.data.data.os && <input type="hidden" name="os" value={result.data.data.os} />}
                {result.data.data.alias && <input type="hidden" name="alias" value={result.data.data.alias} />}
                <input type="hidden" name="actionType" value="commit" />
            </div>
        )}

        {(!result || result.error) && (
            <div class="space-y-4">
                <input type="hidden" name="actionType" value="stage" />
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="hostname" class="block text-sm font-medium text-slate-700">Hostname *</label>
                        <input type="text" name="hostname" id="hostname" required
                            class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" 
                            placeholder="node-01.local"
                            value={result?.data?.data?.hostname || ''} />
                    </div>
                    <div>
                        <label for="ip" class="block text-sm font-medium text-slate-700">IP Address *</label>
                        <input type="text" name="ip" id="ip" required
                            class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" 
                            placeholder="192.168.1.100"
                            value={result?.data?.data?.ip || ''} />
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="mac" class="block text-sm font-medium text-slate-700">MAC Address</label>
                        <input type="text" name="mac" id="mac"
                            class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" 
                            placeholder="00:11:22:33:44:55"
                            value={result?.data?.data?.mac || ''} />
                    </div>
                    <div>
                        <label for="os" class="block text-sm font-medium text-slate-700">Operating System</label>
                        <input type="text" name="os" id="os"
                            class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" 
                            placeholder="Ubuntu 22.04"
                            value={result?.data?.data?.os || ''} />
                    </div>
                </div>

                <div>
                    <label for="alias" class="block text-sm font-medium text-slate-700">Alias (Optional)</label>
                    <input type="text" name="alias" id="alias"
                        class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" 
                        placeholder="k8s-worker"
                        value={result?.data?.data?.alias || ''} />
                </div>
            </div>
        )}

        <div class="pt-4 flex justify-end gap-3 border-t border-slate-100">
            <a href="/mdb" class="bg-white py-2 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Cancel
            </a>
            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                {result && !result.error && result.data.staged ? 'Commit to Pharos' : 'Preview Addition'}
            </button>
        </div>
    </form>
)}
