# ========================================================================
# Project: pharos
# Component: Pulse Heartbeat Agent
# File: crates/pharos-pulse/Containerfile
# Author: Richard D. (https://github.com/iamrichardd)
# License: AGPL-3.0 (See LICENSE file for details)
# * Purpose (The "Why"):
# Production-ready container image for the Pharos Pulse heartbeat agent.
# Provides system presence and health reporting for Home Lab/Enterprise nodes.
# * Traceability:
# Related to Phase 14 (Task 14.1) and Phase 17 (Sandbox).
# ========================================================================

# --- Builder Stage ---
FROM public.ecr.aws/docker/library/rust:1.85-slim AS builder

WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y 
    pkg-config 
    libssl-dev 
    build-essential 
    && rm -rf /var/lib/apt/lists/*

# Copy workspace configuration and locks
COPY Cargo.toml Cargo.lock ./

# Copy all crate structures (needed for workspace resolution)
COPY . .

# Build the pharos-pulse binary in release mode
RUN cargo build --release --bin pharos-pulse

# --- Runtime Stage ---
FROM public.ecr.aws/docker/library/debian:bookworm-slim AS runtime

WORKDIR /app

# Install runtime dependencies (minimal)
RUN apt-get update && apt-get install -y 
    ca-certificates 
    && rm -rf /var/lib/apt/lists/*

# Copy the binary from the builder stage
COPY --from=builder /app/target/release/pharos-pulse /usr/local/bin/pharos-pulse

# Environment (Pulse expects PHAROS_SERVER env var)
ENV PHAROS_SERVER=pharos-server:2378

# Start the agent
ENTRYPOINT ["pharos-pulse"]
